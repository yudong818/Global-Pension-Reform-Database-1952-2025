<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pension Reform — Yearly Map (Slider Only)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root { --bg:#ffffff; --text:#111827; --muted:#6b7280; --brand:#0b5fff; --panel:#f8fafc; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:20; }
    .container { max-width: 1100px; margin: 0 auto; padding: 14px 16px; }
    h1 { font-size: 26px; margin: 0; }
    .sub { color:var(--muted); margin-top: 6px; }
    .panel { border:1px solid var(--border); background:var(--panel); border-radius: 14px; padding: 12px; margin-top: 12px; }
    .controls { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    .slider-wrap { display:flex; align-items:center; gap:10px; }
    input[type=range] { width: 100%; }
    .year-badge { background:#fff; border:1px solid var(--border); padding:6px 10px; border-radius: 10px; font-weight:600; }
    #map { width:100%; height: 75vh; border-radius: 12px; border:1px solid var(--border); margin-top: 12px; }
    .legend { font-size:12px; color:#374151; margin-top: 6px; }
    .leaflet-tooltip { background:#fff; color:#111; border:1px solid var(--border); }
    .btn { border:1px solid var(--border); background:#fff; color:#111; padding:8px 12px; border-radius: 10px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Pension Reform — Yearly Map</h1>
      <div class="sub">Move the slider to pick a year. Bubbles mark countries with a reform in that year. No autoplay, no year buttons.</div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="panel">
        <div class="controls">
          <div class="slider-wrap">
            <span class="muted">Year</span>
            <input id="yearSlider" type="range" min="1950" max="2026" step="1" value="2000" />
            <span id="yearBadge" class="year-badge">2000</span>
          </div>
          <div>
            <button id="dlDataBtn" class="btn">Download Data (year)</button>
          </div>
        </div>
      </div>
      <div id="map"></div>
      <div class="legend">Tooltip shows country name and number of reforms in the selected year.</div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
  let byYear = new Map();
  let years = [];
  let selectedYear = 2000;
  let map, markersLayer, centroidsByName;

  // Slider elements
  const slider = document.getElementById('yearSlider');
  const badge = document.getElementById('yearBadge');

  // Load CSV
  Papa.parse('data.csv', { download:true, header:true, dynamicTyping:true, complete: (res) => {
    const rows = res.data.filter(r => r.Country && r.Year);
    byYear = rows.reduce((m, r) => {
      const y = +r.Year; const name = String(r.Country).trim();
      if (!m.has(y)) m.set(y, []); m.get(y).push(name);
      return m;
    }, new Map());
    years = Array.from(byYear.keys()).sort((a,b)=>a-b);
    // Set slider bounds to actual data
    slider.min = years[0];
    slider.max = years[years.length-1];
    selectedYear = years[0];
    slider.value = selectedYear;
    badge.textContent = selectedYear;
    initMap();
  }});

  function initMap() {
    map = L.map('map', { worldCopyJump: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 6, minZoom: 2, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([20, 0], 2);
    markersLayer = L.layerGroup().addTo(map);

    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r=>r.json()).then(topo => {
      const countries = topojson.feature(topo, topo.objects.countries);
      return fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/country-names.json').then(r=>r.json()).then(nameMap => {
        const idToName = new Map(nameMap.map(d => [d.id, d.name]));
        centroidsByName = new Map();
        countries.features.forEach(f => {
          const nm = idToName.get(f.id);
          if (!nm) return;
          const c = centroidOfFeature(f);
          if (c) centroidsByName.set(nm, c);
        });
        renderBubbles();
      });
    });
  }
  function centroidOfFeature(feature) {
    try {
      const coords = feature.geometry.coordinates;
      const type = feature.geometry.type;
      let pts = [];
      if (type === 'Polygon') coords.forEach(r => r.forEach(p=>pts.push(p)));
      else if (type === 'MultiPolygon') coords.forEach(poly => poly.forEach(r=>r.forEach(p=>pts.push(p))));
      else return null;
      if (!pts.length) return null;
      const lon = pts.reduce((a,p)=>a+p[0],0)/pts.length;
      const lat = pts.reduce((a,p)=>a+p[1],0)/pts.length;
      return [lat, lon];
    } catch(e) { return null; }
  }

  const NAME_ALIASES = new Map([
    ['United States','United States of America'],
    ['Czech Republic','Czechia'],
    ['Congo, Dem. Rep.','Democratic Republic of the Congo'],
    ['Congo, Rep.','Republic of the Congo'],
    ['Kyrgyzstan','Kyrgyz Republic'],
    ['Cape Verde','Cabo Verde'],
    ['Burma','Myanmar'],
    ['Cote d\\'Ivoire','Ivory Coast'],
    ['Côte d’Ivoire','Ivory Coast']
  ]);
  function keyForName(nm) {
    if (centroidsByName.has(nm)) return nm;
    const alias = NAME_ALIASES.get(nm);
    if (alias && centroidsByName.has(alias)) return alias;
    return null;
  }

  function renderBubbles() {
    if (!markersLayer || !centroidsByName) return;
    markersLayer.clearLayers();
    const list = byYear.get(selectedYear) || [];
    const freq = {};
    list.forEach(n => { freq[n] = (freq[n]||0)+1; });

    for (const name in freq) {
      const key = keyForName(name) || name;
      const c = centroidsByName.get(key);
      if (!c) continue;
      const count = freq[name];
      const r = Math.max(6, Math.sqrt(count) * 8);
      const circle = L.circleMarker(c, {
        radius: r, weight: 1, color: '#0b5fff', fillColor: '#8fb3ff', fillOpacity: 0.6, opacity: 0.9
      }).bindTooltip(`<b>${name}</b><br/>Reforms in ${selectedYear}: ${count}`);
      markersLayer.addLayer(circle);
    }
  }

  // Slider interaction
  slider.addEventListener('input', (e) => {
    selectedYear = +e.target.value;
    badge.textContent = selectedYear;
    renderBubbles();
  });

  // Download current year data
  document.getElementById('dlDataBtn').addEventListener('click', () => {
    const list = byYear.get(selectedYear) || [];
    const csv = 'Country,Year\n' + list.map(n => `${n},${selectedYear}`).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`pension-reforms_${selectedYear}.csv`; a.click();
    URL.revokeObjectURL(url);
  });
  </script>
</body>
</html>
